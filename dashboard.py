import streamlit as st
import pandas as pd
import requests
from datetime import datetime

st.set_page_config(page_title="Market Dashboard", layout="wide")

HEADERS = {"User-Agent": "Mozilla/5.0", "Content-Type": "application/json"}
CSV_FILE = "stocks.csv"
TRADES_FILE = "trades.csv"

# =============================
# ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø³Ù‡Ù… Ù…Ù† CSV
# =============================
def load_stocks():
    import os
    if not os.path.exists(CSV_FILE):
        st.warning(f"âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù…Ù„Ù {CSV_FILE}. Ø³ÙŠØªÙ… Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ø®ØªØ¨Ø§Ø±ÙŠØ©.")
        data = {
            "Symbol": ["AAPL","TSLA","AMZN","MSFT","NVDA"],
            "Company": ["Apple Inc.","Tesla Inc.","Amazon.com","Microsoft Corp","Nvidia Corp"],
            "Price": [170,700,130,310,420],
            "Change %": [1.2,2.5,0.8,1.5,3.0],
            "Relative Volume": [1.3,1.8,1.0,1.6,2.0],
            "PE": [28,50,60,35,45]
        }
        return pd.DataFrame(data)
    else:
        return pd.read_csv(CSV_FILE)

# =============================
# Ø¥Ø´Ø§Ø±Ø§Øª ÙˆØ­Ø§Ù„Ø© Ø§Ù„Ø³Ù‡Ù…
# =============================
def add_signals(df):
    if df.empty:
        return df

    df["Ø§Ù„Ø­Ø§Ù„Ø©"] = "ğŸŸ¡ Ù…Ø±Ø§Ù‚Ø¨Ø©"
    df["Ø¥Ø´Ø§Ø±Ø©"] = "âŒ Ù„Ø§"
    df["Ø³Ø¹Ø± Ø§Ù„Ø¯Ø®ÙˆÙ„"] = None
    df["Ø¬Ù†ÙŠ Ø§Ù„Ø£Ø±Ø¨Ø§Ø­"] = None
    df["ÙˆÙ‚Ù Ø§Ù„Ø®Ø³Ø§Ø±Ø©"] = None
    df["Ù‚ÙˆØ© Ø§Ù„Ø³Ù‡Ù…"] = "ğŸ”´ Ø¶Ø¹ÙŠÙ"

    strong_buy = (df["Change %"] > 2) & (df["Relative Volume"] > 1.5) & (df["PE"].fillna(100) < 30)
    potential_buy = ((df["Change %"] > 1) | (df["Relative Volume"] > 1.2)) & (df["PE"].fillna(100) < 50)

    df.loc[strong_buy, "Ø§Ù„Ø­Ø§Ù„Ø©"] = "â­ Ù‚ÙˆÙŠ Ù„Ù„Ø´Ø±Ø§Ø¡"
    df.loc[potential_buy & ~strong_buy, "Ø§Ù„Ø­Ø§Ù„Ø©"] = "âš¡ ÙØ±ØµØ© Ù…Ø­ØªÙ…Ù„Ø©"
    df.loc[df["Change %"] < 0, "Ø§Ù„Ø­Ø§Ù„Ø©"] = "ğŸ”´ Ø¶Ø¹ÙŠÙ"

    df.loc[strong_buy, "Ù‚ÙˆØ© Ø§Ù„Ø³Ù‡Ù…"] = "â­ Ù‚ÙˆÙŠ"
    df.loc[potential_buy & ~strong_buy, "Ù‚ÙˆØ© Ø§Ù„Ø³Ù‡Ù…"] = "âš¡ Ù…ØªÙˆØ³Ø·"

    df.loc[strong_buy, "Ø¥Ø´Ø§Ø±Ø©"] = "ğŸ”¥ Ø´Ø±Ø§Ø¡"
    df.loc[strong_buy, "Ø³Ø¹Ø± Ø§Ù„Ø¯Ø®ÙˆÙ„"] = df["Price"]
    df.loc[strong_buy, "Ø¬Ù†ÙŠ Ø§Ù„Ø£Ø±Ø¨Ø§Ø­"] = (df["Price"] * 1.05).round(2)
    df.loc[strong_buy, "ÙˆÙ‚Ù Ø§Ù„Ø®Ø³Ø§Ø±Ø©"] = (df["Price"] * 0.975).round(2)

    df.loc[potential_buy & ~strong_buy, "Ø¥Ø´Ø§Ø±Ø©"] = "âš¡ Ù…ØªØ§Ø¨Ø¹Ø©"
    df.loc[potential_buy & ~strong_buy, "Ø³Ø¹Ø± Ø§Ù„Ø¯Ø®ÙˆÙ„"] = df["Price"]
    df.loc[potential_buy & ~strong_buy, "Ø¬Ù†ÙŠ Ø§Ù„Ø£Ø±Ø¨Ø§Ø­"] = (df["Price"] * 1.03).round(2)
    df.loc[potential_buy & ~strong_buy, "ÙˆÙ‚Ù Ø§Ù„Ø®Ø³Ø§Ø±Ø©"] = (df["Price"] * 0.985).round(2)

    return df

# =============================
# Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØµÙÙ‚Ø©
# =============================
def trade_analysis(price_buy, current_price):
    gain_percent = (current_price - price_buy) / price_buy * 100
    if gain_percent >= 5:
        return "ğŸ’° ÙŠÙØ¶Ù„ Ø¨ÙŠØ¹ Ø¬Ø²Ø¦ÙŠ"
    elif gain_percent < -3:
        return "âš ï¸ ÙˆÙ‚Ù Ø§Ù„Ø®Ø³Ø§Ø±Ø© / Ø¨ÙŠØ¹"
    else:
        return "â³ Ø§Ù„Ø§Ø³ØªÙ…Ø±Ø§Ø± Ø¨Ø§Ù„ØµÙÙ‚Ø©"

# =============================
# Ø­ÙØ¸ ÙˆÙ…ØªØ§Ø¨Ø¹Ø© Ø§Ù„ØµÙÙ‚Ø§Øª
# =============================
def load_trades():
    import os
    if os.path.exists(TRADES_FILE):
        return pd.read_csv(TRADES_FILE)
    else:
        return pd.DataFrame(columns=["Date","Symbol","Price","Quantity"])

def save_trades(df):
    df.to_csv(TRADES_FILE, index=False)

# =============================
# ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
# =============================
st.title("ğŸ“Š Market Dashboard")
tabs = ["ÙØ±Øµ Ù…Ø¶Ø§Ø±Ø¨ÙŠØ©", "Ø£Ù‚ÙˆÙ‰ Ø§Ù„Ø£Ø³Ù‡Ù…", "Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØµÙÙ‚Ø©", "ØªØªØ¨Ø¹ Ø§Ù„ØµÙÙ‚Ø§Øª", "Ø£Ø¹Ù„Ù‰ Ø§Ù„ÙÙˆÙ„ÙŠÙˆÙ…"]
page = st.tabs(tabs)

# ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
df = load_stocks()
df = add_signals(df)

# =============================
# ØªØ§Ø¨ ÙØ±Øµ Ù…Ø¶Ø§Ø±Ø¨ÙŠØ©
# =============================
with page[0]:
    st.subheader("ÙØ±Øµ Ù…Ø¶Ø§Ø±Ø¨ÙŠØ©")
    if df.empty:
        st.info("Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø­Ø§Ù„ÙŠØ§Ù‹")
    else:
        st.dataframe(df, use_container_width=True, hide_index=True)

# =============================
# ØªØ§Ø¨ Ø£Ù‚ÙˆÙ‰ Ø§Ù„Ø£Ø³Ù‡Ù…
# =============================
with page[1]:
    st.subheader("Ø£Ù‚ÙˆÙ‰ Ø§Ù„Ø£Ø³Ù‡Ù…")
    strong_df = df[df["Ù‚ÙˆØ© Ø§Ù„Ø³Ù‡Ù…"].isin(["â­ Ù‚ÙˆÙŠ","âš¡ Ù…ØªÙˆØ³Ø·"])]
    if strong_df.empty:
        st.info("Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø³Ù‡Ù… Ù‚ÙˆÙŠØ© Ø­Ø§Ù„ÙŠØ§Ù‹")
    else:
        st.dataframe(strong_df, use_container_width=True, hide_index=True)

# =============================
# ØªØ§Ø¨ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØµÙÙ‚Ø©
# =============================
with page[2]:
    st.subheader("Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØµÙÙ‚Ø©")
    symbol = st.text_input("Ø±Ù…Ø² Ø§Ù„Ø³Ù‡Ù…")
    price_buy = st.number_input("Ø³Ø¹Ø± Ø§Ù„Ø´Ø±Ø§Ø¡", min_value=0.0, step=0.01)
    current_price = st.number_input("Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ", min_value=0.0, step=0.01)
    if st.button("ØªØ­Ù„ÙŠÙ„ Ø§Ù„ØµÙÙ‚Ø©"):
        if symbol and price_buy>0 and current_price>0:
            result = trade_analysis(price_buy, current_price)
            st.write(f"Ø§Ù„ØªÙˆØµÙŠØ©: {result}")

# =============================
# ØªØ§Ø¨ ØªØªØ¨Ø¹ Ø§Ù„ØµÙÙ‚Ø§Øª
# =============================
with page[3]:
    st.subheader("ØªØªØ¨Ø¹ Ø§Ù„ØµÙÙ‚Ø§Øª")
    trades_df = load_trades()
    st.dataframe(trades_df, use_container_width=True, hide_index=True)

    st.write("Ø£Ø¶Ù ØµÙÙ‚Ø© Ø¬Ø¯ÙŠØ¯Ø©")
    symbol_new = st.text_input("Ø±Ù…Ø² Ø§Ù„Ø³Ù‡Ù… Ø¬Ø¯ÙŠØ¯")
    price_new = st.number_input("Ø³Ø¹Ø± Ø§Ù„Ø´Ø±Ø§Ø¡ Ø¬Ø¯ÙŠØ¯", min_value=0.0, step=0.01)
    qty_new = st.number_input("Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ù‡Ù…", min_value=1, step=1)
    date_new = st.date_input("ØªØ§Ø±ÙŠØ® Ø§Ù„Ø´Ø±Ø§Ø¡", datetime.today())
    if st.button("Ø­ÙØ¸ Ø§Ù„ØµÙÙ‚Ø©"):
        if symbol_new and price_new>0 and qty_new>0:
            new_trade = pd.DataFrame([{
                "Date": date_new, "Symbol": symbol_new, "Price": price_new, "Quantity": qty_new
            }])
            trades_df = pd.concat([trades_df, new_trade], ignore_index=True)
            save_trades(trades_df)
            st.success("ØªÙ… Ø­ÙØ¸ Ø§Ù„ØµÙÙ‚Ø©")

# =============================
# ØªØ§Ø¨ Ø£Ø¹Ù„Ù‰ Ø§Ù„ÙÙˆÙ„ÙŠÙˆÙ…
# =============================
with page[4]:
    st.subheader("Ø£Ø¹Ù„Ù‰ Ø§Ù„ÙÙˆÙ„ÙŠÙˆÙ…")
    # Ø­Ø§Ù„ÙŠØ§Ù‹ Ù…Ø¬Ø±Ø¯ Ø¹Ø±Ø¶ Ø§Ù„ÙÙˆÙ„ÙŠÙˆÙ… Ø§Ù„Ù†Ø³Ø¨ÙŠ Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ CSV
    hv_df = df[df["Relative Volume"] > 1.5]  # Ù…Ø«Ø§Ù„: Ø£Ø¹Ù„Ù‰ Ù…Ù† Ø§Ù„Ù…ØªÙˆØ³Ø· 1.5
    if hv_df.empty:
        st.info("Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø³Ù‡Ù… Ø¨ÙÙˆÙ„ÙŠÙˆÙ… Ù…Ø±ØªÙØ¹ Ø­Ø§Ù„ÙŠØ§Ù‹")
    else:
        st.dataframe(hv_df, use_container_width=True, hide_index=True)
